namespace de::itemis::vistraq::traceability::computational::language;
 
grammar Query {

    skip SKIP : "\s+" ;
	query : querySource returnDefinition? ;

	querySource : pathQuery | queryReference ;

	queryReference : 'FROM' STORED_QUERY_ID ;

    pathQuery : 'MATCH' artefactSelector;
	artefactSelector : artefactTypeReference ('AS' NAME)? linkSelectorExpression? whereClause?;
	linkSelectorExpression : linkSelector | linkSelectorGroup ;
	linkSelectorGroup : '(' linkSelector operator linkSelector ')' ;
	linkSelector : 'NOT'? 'LINKED' 'VIA' multiplicity? linkTypeReference ('TO'|'FROM') artefactSelector ;
	operator : 'AND' | 'OR' | 'XOR' ;
	multiplicity : POSITIVE_INT '..' POSITIVE_INT ;
	whereClause : 'WHERE' ;

	returnDefinition : 'RETURN' columnDefinition+ orderBy?;
	columnDefinition : aggregateFunctionName? expression 'AS' NAME ;
	expression : root | propertyCall ;
	root : NAME;
	propertyCall : expression '.' NAME ;
	
	orderBy : 'ORDER' 'BY' [columnOrder / ',']+ ;
	columnOrder : NAME ('ASCENDING' | 'DESCENDING')? ;
	
	artefactTypeReference : '*' | NAME ;
	linkTypeReference : '*' | NAME ;
	aggregateFunctionName : NAME ;
	STORED_QUERY_ID : "([a-zA-Z_][a-zA-Z0-9_]*)([.][a-zA-Z_][a-zA-Z0-9_]*)?" ; // project metricDef OR metricSet.metricDef
	NAME : "[a-zA-Z_][a-zA-Z0-9_]*" ;
	POSITIVE_INT : "[0-9]+" ;

}